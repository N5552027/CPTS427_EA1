<!--This is the main home page of the program. -->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/index.css') }}" rel="stylesheet">
</head>
<body>

<!-- Navbar -->
<nav class="navbar navbar-expand-lg sticky-top">
    <div class="container-fluid px-4">
        <!-- <span class="navbar-brand">
            <i class="bi bi-shield-lock-fill me-2"></i>Admin Dashboard
        </span> -->
        <span class="logo">
            
        </span>
        <div class="ms-auto d-flex align-items-center gap-3">
            <span class="navbar-text">
                <i class="bi bi-person-circle me-1"></i>{{ user }}
            </span>
            <a href="/about" class="nav-link">About</a>
            <a href="/logout" class="btn btn-logout btn-sm">
                <i class="bi bi-box-arrow-right me-1"></i>Logout
            </a>
        </div>
    </div>
</nav>

<!-- Main content area -->
<div class="container-fluid px-4 py-4">
    <div class="row g-4">

        <!-- Stream Column -->
        <div class="col-lg-8">
            <p class="section-title mb-2">Live Feed</p>
            <div class="stream-card">
                <div class="card-header d-flex align-items-center gap-2 py-2 px-3">
                    <i class="bi bi-camera-video-fill"></i>
                    Live Stream
                    <span class="live-badge ms-2">
                        <span class="live-dot"></span>LIVE
                    </span>
                </div>
                <div class="ratio ratio-16x9">
                    <iframe
                        src="https://www.youtube.com/embed/CIW5NroAobM?si=s2iZFoaqUXPxVoje&autoplay=1&mute=1"
                        title="Live Stream"
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                        referrerpolicy="strict-origin-when-cross-origin"
                        allowfullscreen>
                    </iframe>
                </div>
            </div>
        </div>

        <!-- Notifications Column -->
        <div class="col-lg-4">
            <p class="section-title mb-2">Alerts</p>
            <div class="notif-card">
                <div class="card-header d-flex align-items-center gap-2 py-2 px-3">
                    <i class="bi bi-bell-fill"></i>
                    Recent Notifications
                    {% if notifications %}
                    <span class="badge bg-danger ms-auto">{{ notifications|length }}</span>
                    {% endif %}
                </div>

                <!--10 Most recent events-->
                <div class="card-body p-3 d-flex flex-column gap-2 notif-scroll">
                    {% if notifications %}
                        {% for n in notifications[:10] %}
                        <div class="notif-item p-3">
                            <div class="d-flex align-items-start gap-2">
                                
                                <!--Event Wrapper-->
                                <i class="bi bi-{{ n.icon }} text-{{ n.color }} mt-1 flex-shrink-0"></i>
                                <div>
                                    <!--Details about the notification-->
                                    <div class="notif-detail text-white">{{ n.detail }}</div>
                                    
                                    <!--Time of the notification-->
                                    <div class="notif-time mt-1">
                                        <i class="bi bi-clock me-1"></i>{{ n.time }}
                                    </div>

                                    <!--Video clip of the notification-->
                                    <div class="video-evidence-modal" class="modal">
                                        <div class="video-evidence-content">
                                            <iframe id="YoutubeStream"
                                                src="{{ n.evidence_url }}"
                                                title="Video Evidence"
                                                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                                                referrerpolicy="strict-origin-when-cross-origin"
                                                allowfullscreen>
q                                            </iframe>   
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <p class="text-center text-muted py-3 mb-0">
                            <i class="bi bi-check-circle me-1"></i>No alerts
                        </p>
                    {% endif %}
                </div>
            </div>
        </div>

    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>


<script>

    // When a notification is clicked, open the modal and set the video source to the evidence URL
    function openEvidenceModal() {
        // open the modal
        document.getElementById("video-evidence-modal").style.display = "block";
    }

    // When the user clicks anywhere outside of the modal, close it and stop the video
    window.onclick = function(event) {    
        // Get the modal element
        const modal = document.getElementById("video-evidence-modal");
        
        // If the click target is the modal itself (i.e., outside the video content), close the modal
        if (event.target == modal) {
            modal.style.display = "none"; // hide the modal
            document.getElementById("YoutubeStream").src = ""; // stop the video
        }
    }

    // Track the highest event id we've seen so we only fetch new ones
    let lastId = {{ (notifications[0].id if notifications else 0) }}; // Some flask things that my computer is tripping over 
    
    // build any new notification items into HTML format so we can insert them into the page
    function buildItem(n) {
        return `
        <div class="notif-item p-3">
            <div class="d-flex align-items-start gap-2">
                <i class="bi bi-${n.icon} text-${n.color} mt-1 flex-shrink-0"></i>
                <div>
                    <div class="notif-detail text-white">${n.detail}</div>
                    <div class="notif-time mt-1">
                        <i class="bi bi-clock me-1"></i>${n.time}
                    </div>
                    <div class="video-evidence-modal" class="modal">
                        <div class="video-evidence-content">
                            <iframe id="YoutubeStream"
                                src="${n.evidence_url}"
                                title="Video Evidence"
                                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                                referrerpolicy="strict-origin-when-cross-origin"
                                allowfullscreen>
                            </iframe>
                </div>
            </div>
        </div>`;
    }

    // Asynchronous polling function to fetch new events without blocking the UI
    async function pollEvents() {

        if (polling) return; // Prevent overlapping polls

        polling = true; // Mark polling as in progress

        // Try to fetch new events from the server since the last seen id
        try {
            const res = await fetch(`/api/events?since=${lastId}`);
            if (!res.ok) return;
            const events = await res.json();
            if (events.length === 0) return;

            const body = document.querySelector(".notif-card .card-body");
            const badge = document.querySelector(".notif-card .badge");

            // Remove "no alerts" placeholder if present
            const placeholder = body.querySelector("p");
            if (placeholder) placeholder.remove();

            events.forEach(n => {
                lastId = Math.max(lastId, n.id);
                body.insertAdjacentHTML("afterbegin", buildItem(n));
            });

            // Update badge count
            const count = body.querySelectorAll(".notif-item").length;
            if (badge) {
                badge.textContent = count;
            } else {
                const header = document.querySelector(".notif-card .card-header");
                header.insertAdjacentHTML("beforeend",
                    `<span class="badge bg-danger ms-auto">${count}</span>`);
            }
        } 
        
        // In case of any errors (network issues, server errors, etc), log them but don't disrupt the user experience
        catch (e) {
            console.error("poll error", e);
        }

        // Mark polling as finished so the next one can run
        finally {
            polling = false;
        }
    }
    setInterval(pollEvents, 5000); // Poll every 5 seconds
</script>

</body>
</html>
