Bootstrap: docker
From: nvidia/cuda:11.8.0-cudnn8-runtime-ubuntu22.04

%post
    # Set non-interactive mode for apt
    export DEBIAN_FRONTEND=noninteractive

    # Update and install system dependencies
    apt-get update && apt-get install -y \
        python3.10 \
        python3-pip \
        python3-dev \
        build-essential \
        cmake \
        git \
        wget \
        curl \
        libgl1-mesa-glx \
        libglib2.0-0 \
        libsm6 \
        libxext6 \
        libxrender-dev \
        libgomp1 \
        libgstreamer1.0-0 \
        libgstreamer-plugins-base1.0-0 \
        libgtk-3-0 \
        libavcodec-dev \
        libavformat-dev \
        libswscale-dev \
        libv4l-dev \
        libxvidcore-dev \
        libx264-dev \
        libjpeg-dev \
        libpng-dev \
        libtiff-dev \
        libatlas-base-dev \
        gfortran \
        ffmpeg \
        libopenblas-dev \
        liblapack-dev \
        ca-certificates \
        && rm -rf /var/lib/apt/lists/*

    # Upgrade pip
    python3 -m pip install --upgrade pip setuptools wheel

    # Install PyTorch with CUDA support
    pip3 install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu118

    # Install Python dependencies
    pip3 install \
        opencv-python>=4.8.0.74 \
        opencv-contrib-python>=4.8.0.74 \
        streamlink \
        ultralytics \
        flask \
        "numpy>=1.24.0,<2.0.0" \
        face-recognition \
        dlib \
        Pillow \
        matplotlib \
        scipy \
        scikit-learn \
        pandas

    # Clean up
    apt-get clean
    rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*

%environment
    # Set Python path
    export PATH=/usr/bin:$PATH
    export PYTHONPATH=/usr/local/lib/python3.10/dist-packages:$PYTHONPATH

    # OpenCV environment variables
    export OPENCV_VIDEOIO_PRIORITY_GSTREAMER=0

    # CUDA environment variables
    export CUDA_HOME=/usr/local/cuda
    export PATH=$CUDA_HOME/bin:$PATH
    export LD_LIBRARY_PATH=$CUDA_HOME/lib64:$LD_LIBRARY_PATH

    # Set matplotlib backend for headless environments
    export MPLBACKEND=Agg

    # Flask environment
    export FLASK_APP=app.py
    export FLASK_ENV=development

%runscript
    echo "CrimsonCode 2026 Container"
    echo "Available Python: $(python3 --version)"
    echo "Available PyTorch: $(python3 -c 'import torch; print(torch.__version__)')"
    echo "CUDA Available: $(python3 -c 'import torch; print(torch.cuda.is_available())')"
    exec "$@"

%labels
    Author Calvin
    Version v1.0
    Description Singularity container for CrimsonCode 2026 project with YOLO, OpenCV, and deep learning dependencies

%help
    This container provides a complete environment for the CrimsonCode 2026 project.

    Usage:

    Build the container:
        singularity build crimsoncode.sif crimsoncode.def

    Run Python scripts:
        singularity exec crimsoncode.sif python3 get_training_data.py
        singularity exec crimsoncode.sif python3 streaming.py
        singularity exec crimsoncode.sif python3 app.py

    Interactive shell:
        singularity shell crimsoncode.sif

    With GPU support:
        singularity exec --nv crimsoncode.sif python3 your_script.py

    With camera access:
        singularity exec --bind /dev/video0 crimsoncode.sif python3 get_training_data.py

    Run Flask app:
        singularity exec --bind $(pwd):/app --pwd /app crimsoncode.sif python3 app.py
